name: ğŸ›¡ï¸ Praetorian CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  NPM_VERSION: '9'

jobs:
  # ğŸ” Code Quality & Security
  code-quality:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§¹ Lint code
        run: npm run lint

      - name: ğŸ”§ Type check
        run: npm run build

  # ğŸ§ª Testing & Coverage
  test:
    name: ğŸ§ª Testing & Coverage
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests
        run: npm test -- --coverage --watchAll=false --verbose=false

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

      - name: ğŸ§¬ Mutation Testing
        run: npm run test:mutation
        continue-on-error: true

  # ğŸ“¦ Build & Package
  build:
    name: ğŸ“¦ Build & Package
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Build project
        run: npm run build

      - name: ğŸ“¦ Package size analysis
        run: |
          echo "ğŸ“Š Bundle size analysis:"
          du -sh dist/
          echo "ğŸ“ Directory structure:"
          find dist/ -type f -name "*.js" -exec wc -l {} + | tail -1

  # ğŸš€ Release (only on main branch)
  release:
    name: ğŸš€ Release
    runs-on: ubuntu-latest
    needs: [code-quality, test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Build project
        run: npm run build

      - name: ğŸ“¦ Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: true
          body: |
            ## ğŸš€ Praetorian CLI ${{ github.ref_name }} Release

            ### âœ¨ New Features
            - **Pipeline Mode** - CI/CD friendly output with `--pipeline` flag
            - **Dual Output Modes** - User-friendly detailed output + concise pipeline output
            - **DevSecOps Integration** - Ready for Jenkins, GitHub Actions, Dockerfile, Makefile

            ### ğŸ”§ Improvements
            - Enhanced CLI with professional banner
            - Improved test coverage (1,201 tests)
            - Better error handling and validation

            ### ğŸ“¦ Installation
            ```bash
            npm install -g @syntropysoft/praetorian
            ```

            ### ğŸš€ Usage
            ```bash
            # User mode (detailed output)
            praetorian validate --config praetorian.yaml

            # Pipeline mode (CI/CD friendly)
            praetorian validate --config praetorian.yaml --pipeline
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ“Š Security Audit
  security-audit:
    name: ğŸ“Š Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run security audit
        run: npm audit --audit-level=moderate

      - name: ğŸ”’ Check for vulnerabilities
        run: |
          if npm audit --audit-level=high --json | grep -q '"vulnerabilities":{}'; then
            echo "âœ… No high-severity vulnerabilities found"
          else
            echo "âŒ High-severity vulnerabilities detected"
            npm audit --audit-level=high
            exit 1
          fi
